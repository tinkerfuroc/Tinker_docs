"use strict";(self.webpackChunktinker_wiki=self.webpackChunktinker_wiki||[]).push([[3763],{6712:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>i,default:()=>m,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var t=n(4848),r=n(8453);const o={last_update:{date:"8/3/2024",author:"Cabbage Dog"}},i="Message Filter in ROS2",a={id:"Program/mesage_filter",title:"Message Filter in ROS2",description:"Typically we use a subscriber to directly receive the message and process them in a callback function, but there are times when we want more intricate ways to tackle with these messages, say, cache them temporarily process them later, or synchronize messages from mulitple topics then process them in batch.",source:"@site/docs/Program/mesage_filter.md",sourceDirName:"Program",slug:"/Program/mesage_filter",permalink:"/tinkerdocs/docs/Program/mesage_filter",draft:!1,unlisted:!1,editUrl:"https://github.com/tinkerfuroc/tinkerdocs/docs/Program/mesage_filter.md",tags:[],version:"current",lastUpdatedBy:"Cabbage Dog",lastUpdatedAt:17226432e5,frontMatter:{last_update:{date:"8/3/2024",author:"Cabbage Dog"}},sidebar:"tutorialSidebar",previous:{title:"Callback Function In ROS2 Pub and Sub",permalink:"/tinkerdocs/docs/Program/cpp_function_pointer"},next:{title:"\u89c6\u89c9",permalink:"/tinkerdocs/docs/category/\u89c6\u89c9"}},c={},l=[{value:"Synchronizer",id:"synchronizer",level:2},{value:"Code Explained",id:"code-explained",level:3},{value:"What More",id:"what-more",level:3}];function d(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{id:"message-filter-in-ros2",children:"Message Filter in ROS2"}),"\n",(0,t.jsx)(s.p,{children:"Typically we use a subscriber to directly receive the message and process them in a callback function, but there are times when we want more intricate ways to tackle with these messages, say, cache them temporarily process them later, or synchronize messages from mulitple topics then process them in batch."}),"\n",(0,t.jsxs)(s.p,{children:["Currently, ",(0,t.jsx)(s.code,{children:"message_filters"})," in ROS2 provide some convenient ways to implement these functions. However, up to the date of the creation of this blog, ",(0,t.jsx)(s.code,{children:"message_filters"})," are still under development and many functions remains unimplemented. This blog will introduce time synchronizer in ",(0,t.jsx)(s.code,{children:"message_filters"}),"."]}),"\n",(0,t.jsx)(s.h2,{id:"synchronizer",children:"Synchronizer"}),"\n",(0,t.jsx)(s.p,{children:"A synchronizer is mainly used when you want to subscribe messages from multiple topics and process them in batch based on their time stamp. In navigation, you may want to use data from IMU and LiDAR from the same time to establish your odometry. Here is the example for implementation in python:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:"import rclpy\nfrom rclpy.node import Node\n\nfrom sensor_msgs.msg import PointCloud2\nfrom sensor_msgs.msg import Imu\nfrom message_filters import Subscriber, ApproximateTimeSynchronizer\n\nclass Compute_odom(Node):\n\n    def __init__(self):\n        super().__init__('Compute_odom')\n        self.subs = []\n        \n        self.subs.append(Subscriber(self,  PointCloud2, \"/livox/lidar\"))\n        self.subs.append(Subscriber(self,  PointCloud2, \"/my_imu\"))\n\n        self.ts = ApproximateTimeSynchronizer(self.subs, queue_size=5, slop=0.1)\n        self.ts.registerCallback(self.ts_callback)\n\n    def ts_callback(self, p0, p1):\n        # Code you implement odometry\n        self.get_logger().info('Common callback called')\n\n\ndef main(args=None):\n    rclpy.init(args=args)\n\n    Compute_odom = Compute_odom()\n\n    rclpy.spin(Compute_odom)\n    \n    Compute_odom.destroy_node()\n    rclpy.shutdown()\n\n\nif __name__ == '__main__':\n    main()\n"})}),"\n",(0,t.jsx)(s.h3,{id:"code-explained",children:"Code Explained"}),"\n",(0,t.jsxs)(s.p,{children:["In the above code, we create a subscription list for subscribers we want to synchronize. But, instead of creating a ",(0,t.jsx)(s.code,{children:"subscription"})," in ROS2, we create a ",(0,t.jsx)(s.code,{children:"Subscriber"})," in ",(0,t.jsx)(s.code,{children:"message_filter"})]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'sub = Subscriber(self, PointCloud2, "/livox/lidar")\n'})}),"\n",(0,t.jsxs)(s.p,{children:["Pay attention, we don't designate the callback function as  we create ",(0,t.jsx)(s.code,{children:"subscription"}),". Actually this ",(0,t.jsx)(s.code,{children:"Subscriber"}),' is a part of "Filter Chain". It just receives the message and gives this message to the following part of the "Filter Chain" to process.']}),"\n",(0,t.jsxs)(s.p,{children:["Then we declare a ",(0,t.jsx)(s.code,{children:"ApproximateTimeSynchronizer"}),", it synchronizes our subs, but with a slop. The slop means if the messages' time stamps are within slop, they will be process in a batch."]}),"\n",(0,t.jsx)(s.p,{children:"But what do we use to process this batch of data? We register a callback function of course."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:"self.ts.registerCallback(self.ts_callback)\n"})}),"\n",(0,t.jsx)(s.p,{children:"The callback function receives all messages in this batch at once, and you can process them altogehter."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:"    def ts_callback(self, p0, p1):\n        # Code you implement odometry\n        self.get_logger().info('Common callback called')\n"})}),"\n",(0,t.jsx)(s.h3,{id:"what-more",children:"What More"}),"\n",(0,t.jsxs)(s.p,{children:["We can expect more functions from ",(0,t.jsx)(s.code,{children:"message_filter"}),", but currently there are only few functions implemented. You can follow the ",(0,t.jsx)(s.a,{href:"https://github.com/ros2/message_filters/blob/rolling/doc/index.rst",children:"official repo"})," to see what is added.(There are still some errors in this doc, pay attention.)"]})]})}function m(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>i,x:()=>a});var t=n(6540);const r={},o=t.createContext(r);function i(e){const s=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(o.Provider,{value:s},e.children)}}}]);